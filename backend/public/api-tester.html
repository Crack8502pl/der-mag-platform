<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Der-Mag Platform - API Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: #2d2d2d;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #007bff;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .auth-status span {
            color: #888;
        }

        .auth-status.logged-in span {
            color: #28a745;
        }

        /* Main Layout */
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #2d2d2d;
            border-right: 1px solid #3a3a3a;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: #3a3a3a;
        }

        .nav-item.active {
            background: #3a3a3a;
            border-left-color: #007bff;
        }

        .nav-item span {
            margin-right: 0.5rem;
        }

        /* Main Content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            margin-bottom: 1.5rem;
            color: #007bff;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #b0b0b0;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: #2d2d2d;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 0.95rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Buttons */
        button {
            padding: 0.75rem 1.5rem;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        button:hover {
            background: #0056b3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #545b62;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        /* Response Panel */
        .response-panel {
            width: 500px;
            background: #2d2d2d;
            border-left: 1px solid #3a3a3a;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .response-header {
            padding: 1rem;
            border-bottom: 1px solid #3a3a3a;
        }

        .response-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: bold;
        }

        .status-badge.success {
            background: #28a745;
            color: white;
        }

        .status-badge.error {
            background: #dc3545;
            color: white;
        }

        .response-body {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .response-body pre {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .history {
            border-top: 1px solid #3a3a3a;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .history h3 {
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #b0b0b0;
        }

        .history-item {
            padding: 0.5rem;
            background: #1a1a1a;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #252525;
        }

        .history-item .time {
            font-size: 0.75rem;
            color: #888;
        }

        .history-item .request {
            font-weight: bold;
            margin: 0.25rem 0;
        }

        .history-item .status {
            font-size: 0.85rem;
        }

        /* Token Display */
        .token-display {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            word-break: break-all;
            font-size: 0.85rem;
        }

        /* List Items */
        .list-container {
            margin-top: 1rem;
        }

        .list-item {
            background: #2d2d2d;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            border-left: 3px solid #007bff;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        /* Button Group */
        .button-group {
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üß™ Der-Mag API Tester</h1>
        <div class="auth-status" id="authStatus">
            <span>‚óè Wylogowany</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="nav-item active" data-section="auth">
                <span>üîê</span> Autentykacja
            </div>
            <div class="nav-item" data-section="users">
                <span>üë•</span> U≈ºytkownicy
            </div>
            <div class="nav-item" data-section="tasks">
                <span>üìã</span> Zadania
            </div>
            <div class="nav-item" data-section="task-types">
                <span>üìë</span> Typy zada≈Ñ
            </div>
            <div class="nav-item" data-section="bom">
                <span>üîß</span> BOM
            </div>
            <div class="nav-item" data-section="devices">
                <span>üì±</span> UrzƒÖdzenia
            </div>
            <div class="nav-item" data-section="activities">
                <span>‚úÖ</span> Aktywno≈õci
            </div>
            <div class="nav-item" data-section="metrics">
                <span>üìä</span> Metryki
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Authentication Section -->
            <div class="section active" id="auth">
                <h2>üîê Autentykacja</h2>

                <div class="form-group">
                    <label>Nazwa u≈ºytkownika:</label>
                    <input type="text" id="loginUsername" value="admin" placeholder="np. admin">
                </div>

                <div class="form-group">
                    <label>Has≈Ço:</label>
                    <input type="password" id="loginPassword" value="Admin123!" placeholder="Has≈Ço">
                </div>

                <div class="button-group">
                    <button onclick="login()">Zaloguj siƒô</button>
                    <button class="secondary" onclick="testMe()">Test /api/auth/me</button>
                    <button class="danger" onclick="logout()">Wyloguj</button>
                </div>

                <div class="token-display" id="tokenDisplay">
                    <strong>Token JWT:</strong><br>
                    <span id="tokenText">Brak tokena</span>
                </div>
            </div>

            <!-- Users Section -->
            <div class="section" id="users">
                <h2>üë• U≈ºytkownicy</h2>

                <div class="button-group">
                    <button onclick="listUsers()">Lista u≈ºytkownik√≥w</button>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Dodaj u≈ºytkownika</h3>

                <div class="form-group">
                    <label>Nazwa u≈ºytkownika:</label>
                    <input type="text" id="userUsername" placeholder="np. jan.kowalski">
                </div>

                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="userEmail" placeholder="jan.kowalski@dermag.lan">
                </div>

                <div class="form-group">
                    <label>Has≈Ço:</label>
                    <input type="password" id="userPassword" placeholder="Minimum 8 znak√≥w">
                </div>

                <div class="form-group">
                    <label>Imiƒô:</label>
                    <input type="text" id="userFirstName" placeholder="Jan">
                </div>

                <div class="form-group">
                    <label>Nazwisko:</label>
                    <input type="text" id="userLastName" placeholder="Kowalski">
                </div>

                <div class="form-group">
                    <label>Rola:</label>
                    <select id="userRole">
                        <option value="1">1 - Admin</option>
                        <option value="2">2 - Manager</option>
                        <option value="3">3 - Koordynator</option>
                        <option value="4">4 - Technik</option>
                        <option value="5">5 - Viewer</option>
                    </select>
                </div>

                <button onclick="createUser()">Utw√≥rz u≈ºytkownika</button>
            </div>

            <!-- Tasks Section -->
            <div class="section" id="tasks">
                <h2>üìã Zadania</h2>

                <div class="button-group">
                    <button onclick="listTasks()">Lista wszystkich zada≈Ñ</button>
                    <button onclick="listMyTasks()">Moje zadania</button>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Dodaj zadanie</h3>

                <div class="form-group">
                    <label>Nazwa zadania:</label>
                    <input type="text" id="taskName" placeholder="np. Instalacja SMW Warszawa Centralna">
                </div>

                <div class="form-group">
                    <label>Opis:</label>
                    <textarea id="taskDescription" placeholder="Szczeg√≥≈Çowy opis zadania..."></textarea>
                </div>

                <div class="form-group">
                    <label>Lokalizacja:</label>
                    <input type="text" id="taskLocation" placeholder="np. Warszawa Centralna, peron 2">
                </div>

                <div class="form-group">
                    <label>Typ zadania:</label>
                    <select id="taskType">
                        <option value="1">1 - SMW (System Monitoringu Wizyjnego)</option>
                        <option value="2">2 - CSDIP</option>
                        <option value="3">3 - LAN PKP PLK</option>
                        <option value="4">4 - SMOK-IP/CMOK-IP (Wariant A/SKP)</option>
                        <option value="5">5 - SMOK-IP/CMOK-IP (Wariant B)</option>
                        <option value="6">6 - SSWiN</option>
                        <option value="7">7 - SSP</option>
                        <option value="8">8 - SUG</option>
                        <option value="9">9 - Obiekty Kubaturowe</option>
                        <option value="10">10 - Kontrakty Liniowe</option>
                        <option value="11">11 - LAN Strukturalny Miedziana</option>
                        <option value="12">12 - Zasilania</option>
                        <option value="13">13 - Struktury ≈öwiat≈Çowodowe</option>
                        <option value="14">14 - SERWIS (Zadanie Serwisowe)</option>
                    </select>
                </div>

                <button onclick="createTask()">Utw√≥rz zadanie</button>
            </div>

            <!-- Task Types Section -->
            <div class="section" id="task-types">
                <h2>üìë Typy zada≈Ñ</h2>

                <div class="button-group">
                    <button onclick="listTaskTypes()">Lista typ√≥w zada≈Ñ</button>
                </div>
            </div>

            <!-- BOM Section -->
            <div class="section" id="bom">
                <h2>üîß BOM (Bill of Materials)</h2>

                <div class="button-group">
                    <button onclick="getAllBOMTemplates()">Wszystkie szablony BOM</button>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Szablony BOM dla typu zadania</h3>

                <div class="form-group">
                    <label>Kod typu zadania:</label>
                    <input type="text" id="bomTaskTypeCode" placeholder="np. SMW, CSDIP, SERWIS">
                </div>

                <button onclick="getBOMByTaskType()">Pobierz szablony BOM</button>
            </div>

            <!-- Devices Section -->
            <div class="section" id="devices">
                <h2>üì± UrzƒÖdzenia</h2>

                <h3>Rejestracja urzƒÖdzenia</h3>

                <div class="form-group">
                    <label>Numer seryjny:</label>
                    <input type="text" id="deviceSerialNumber" placeholder="np. SN123456789">
                </div>

                <div class="form-group">
                    <label>Kod materia≈Çowy:</label>
                    <input type="text" id="deviceMaterialCode" placeholder="np. CAM-IP-2MP-IR30">
                </div>

                <div class="form-group">
                    <label>Typ urzƒÖdzenia:</label>
                    <input type="text" id="deviceType" placeholder="np. Kamera IP">
                </div>

                <button onclick="registerDevice()">Zarejestruj urzƒÖdzenie</button>
            </div>

            <!-- Activities Section -->
            <div class="section" id="activities">
                <h2>‚úÖ Aktywno≈õci</h2>

                <div class="button-group">
                    <button onclick="getActivityTemplates()">Szablony aktywno≈õci</button>
                </div>
            </div>

            <!-- Metrics Section -->
            <div class="section" id="metrics">
                <h2>üìä Metryki</h2>

                <div class="button-group">
                    <button onclick="getDashboard()">Dashboard</button>
                    <button onclick="getTaskMetrics()">Statystyki zada≈Ñ</button>
                </div>
            </div>
        </div>

        <!-- Response Panel -->
        <div class="response-panel">
            <div class="response-header">
                <div class="response-status">
                    <span id="responseStatusBadge"></span>
                    <span id="responseTime"></span>
                </div>
            </div>

            <div class="response-body">
                <pre id="responseBody">Brak odpowiedzi - wykonaj zapytanie API</pre>
            </div>

            <div class="history">
                <h3>Historia zapyta≈Ñ</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script>
        // Konfiguracja API
        const API_URL = 'http://localhost:3000/api';

        // Stan aplikacji
        let authToken = localStorage.getItem('authToken') || null;
        let requestHistory = JSON.parse(localStorage.getItem('requestHistory') || '[]');

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthStatus();
            updateTokenDisplay();
            updateHistoryList();
            setupNavigation();
        });

        // Nawigacja
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    
                    item.classList.add('active');
                    document.getElementById(section).classList.add('active');
                });
            });
        }

        // Funkcja wykonujƒÖca zapytanie API
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const startTime = performance.now();
            
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (authToken) {
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                }

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_URL}${endpoint}`, options);
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);

                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    data = { message: await response.text() };
                }

                const result = {
                    success: response.ok,
                    status: response.status,
                    data,
                    duration
                };

                displayResponse(result, method, endpoint);
                addToHistory(method, endpoint, response.status, duration);

                return result;
            } catch (error) {
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);

                const result = {
                    success: false,
                    status: 0,
                    data: { error: error.message },
                    duration
                };

                displayResponse(result, method, endpoint);
                addToHistory(method, endpoint, 0, duration);

                return result;
            }
        }

        // Wy≈õwietlanie odpowiedzi
        function displayResponse(result, method, endpoint) {
            const statusBadge = document.getElementById('responseStatusBadge');
            const responseTime = document.getElementById('responseTime');
            const responseBody = document.getElementById('responseBody');

            // Status
            const statusClass = result.success ? 'success' : 'error';
            const statusIcon = result.success ? 'üü¢' : 'üî¥';
            statusBadge.className = `status-badge ${statusClass}`;
            statusBadge.textContent = `${statusIcon} ${result.status}`;

            // Czas
            responseTime.textContent = `${result.duration}ms`;

            // Body
            responseBody.textContent = JSON.stringify(result.data, null, 2);
        }

        // Dodawanie do historii
        function addToHistory(method, endpoint, status, duration) {
            const now = new Date();
            const time = now.toLocaleTimeString('pl-PL');

            const historyItem = {
                time,
                method,
                endpoint,
                status,
                duration,
                timestamp: now.getTime()
            };

            requestHistory.unshift(historyItem);
            requestHistory = requestHistory.slice(0, 10);

            localStorage.setItem('requestHistory', JSON.stringify(requestHistory));
            updateHistoryList();
        }

        // Aktualizacja listy historii
        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            
            if (requestHistory.length === 0) {
                historyList.innerHTML = '<div style="color: #888; font-size: 0.9rem;">Brak historii</div>';
                return;
            }

            historyList.innerHTML = requestHistory.map(item => {
                const statusClass = item.status >= 200 && item.status < 300 ? 'success' : 'error';
                return `
                    <div class="history-item">
                        <div class="time">${item.time}</div>
                        <div class="request">${item.method} ${item.endpoint}</div>
                        <div class="status">
                            <span class="status-badge ${statusClass}">${item.status}</span>
                            <span style="color: #888; margin-left: 0.5rem;">${item.duration}ms</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Aktualizacja statusu autentykacji
        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            if (authToken) {
                authStatus.innerHTML = '<span>‚óè Zalogowany</span>';
                authStatus.classList.add('logged-in');
            } else {
                authStatus.innerHTML = '<span>‚óè Wylogowany</span>';
                authStatus.classList.remove('logged-in');
            }
        }

        // Aktualizacja wy≈õwietlania tokena
        function updateTokenDisplay() {
            const tokenText = document.getElementById('tokenText');
            if (authToken) {
                tokenText.textContent = authToken;
            } else {
                tokenText.textContent = 'Brak tokena';
            }
        }

        // === AUTENTYKACJA ===

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('Podaj nazwƒô u≈ºytkownika i has≈Ço');
                return;
            }

            const result = await apiRequest('/auth/login', 'POST', { username, password });

            if (result.success && result.data.token) {
                authToken = result.data.token;
                localStorage.setItem('authToken', authToken);
                updateAuthStatus();
                updateTokenDisplay();
                alert('Zalogowano pomy≈õlnie!');
            } else {
                alert('B≈ÇƒÖd logowania: ' + (result.data.message || 'Nieznany b≈ÇƒÖd'));
            }
        }

        async function logout() {
            await apiRequest('/auth/logout', 'POST');
            authToken = null;
            localStorage.removeItem('authToken');
            updateAuthStatus();
            updateTokenDisplay();
            alert('Wylogowano');
        }

        async function testMe() {
            await apiRequest('/auth/me', 'GET');
        }

        // === U≈ªYTKOWNICY ===

        async function listUsers() {
            await apiRequest('/users', 'GET');
        }

        async function createUser() {
            const userData = {
                username: document.getElementById('userUsername').value,
                email: document.getElementById('userEmail').value,
                password: document.getElementById('userPassword').value,
                firstName: document.getElementById('userFirstName').value,
                lastName: document.getElementById('userLastName').value,
                roleId: parseInt(document.getElementById('userRole').value)
            };

            if (!userData.username || !userData.email || !userData.password || 
                !userData.firstName || !userData.lastName) {
                alert('Wype≈Çnij wszystkie pola');
                return;
            }

            const result = await apiRequest('/users', 'POST', userData);

            if (result.success) {
                alert('U≈ºytkownik utworzony pomy≈õlnie!');
                // Wyczy≈õƒá formularz
                document.getElementById('userUsername').value = '';
                document.getElementById('userEmail').value = '';
                document.getElementById('userPassword').value = '';
                document.getElementById('userFirstName').value = '';
                document.getElementById('userLastName').value = '';
            } else {
                alert('B≈ÇƒÖd: ' + (result.data.message || 'Nie uda≈Ço siƒô utworzyƒá u≈ºytkownika'));
            }
        }

        // === ZADANIA ===

        async function listTasks() {
            await apiRequest('/tasks', 'GET');
        }

        async function listMyTasks() {
            await apiRequest('/tasks/my', 'GET');
        }

        async function createTask() {
            const taskData = {
                name: document.getElementById('taskName').value,
                description: document.getElementById('taskDescription').value,
                location: document.getElementById('taskLocation').value,
                taskTypeId: parseInt(document.getElementById('taskType').value)
            };

            if (!taskData.name || !taskData.location) {
                alert('Wype≈Çnij przynajmniej nazwƒô i lokalizacjƒô');
                return;
            }

            const result = await apiRequest('/tasks', 'POST', taskData);

            if (result.success) {
                alert('Zadanie utworzone pomy≈õlnie!');
                // Wyczy≈õƒá formularz
                document.getElementById('taskName').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskLocation').value = '';
            } else {
                alert('B≈ÇƒÖd: ' + (result.data.message || 'Nie uda≈Ço siƒô utworzyƒá zadania'));
            }
        }

        // === TYPY ZADA≈É ===

        async function listTaskTypes() {
            // Endpoint do pobrania wszystkich typ√≥w zada≈Ñ - trzeba go zaimplementowaƒá w API
            // lub u≈ºyƒá endpointu BOM templates bez parametru
            await apiRequest('/bom/templates', 'GET');
        }

        // === BOM ===

        async function getAllBOMTemplates() {
            await apiRequest('/bom/templates', 'GET');
        }

        async function getBOMByTaskType() {
            const taskType = document.getElementById('bomTaskTypeCode').value;

            if (!taskType) {
                alert('Podaj kod typu zadania');
                return;
            }

            await apiRequest(`/bom/templates/${taskType}`, 'GET');
        }

        // === URZƒÑDZENIA ===

        async function registerDevice() {
            const deviceData = {
                serialNumber: document.getElementById('deviceSerialNumber').value,
                materialCode: document.getElementById('deviceMaterialCode').value,
                deviceType: document.getElementById('deviceType').value
            };

            if (!deviceData.serialNumber || !deviceData.materialCode || !deviceData.deviceType) {
                alert('Wype≈Çnij wszystkie pola');
                return;
            }

            const result = await apiRequest('/devices/serial', 'POST', deviceData);

            if (result.success) {
                alert('UrzƒÖdzenie zarejestrowane pomy≈õlnie!');
                // Wyczy≈õƒá formularz
                document.getElementById('deviceSerialNumber').value = '';
                document.getElementById('deviceMaterialCode').value = '';
                document.getElementById('deviceType').value = '';
            } else {
                alert('B≈ÇƒÖd: ' + (result.data.message || 'Nie uda≈Ço siƒô zarejestrowaƒá urzƒÖdzenia'));
            }
        }

        // === AKTYWNO≈öCI ===

        async function getActivityTemplates() {
            await apiRequest('/activities/templates', 'GET');
        }

        // === METRYKI ===

        async function getDashboard() {
            await apiRequest('/metrics/dashboard', 'GET');
        }

        async function getTaskMetrics() {
            await apiRequest('/metrics/task-types', 'GET');
        }
    </script>
</body>
</html>
